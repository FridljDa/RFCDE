---
title: "RFCDE"
author: "Taylor Pospisil"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{RFCDE}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Random forests is a common non-parametric regression technique which
performs well for mixed-type data and irrelevant covariates, while
being robust to monotonic variable transformations. RFCDE fits random
forest models optimized for nonparametric conditional density
estimation.

## Example

```{r}
#library(RFCDE)
devtools::load_all()
set.seed(42)

generate_data <- function(n) {
  x_relevant <- matrix(runif(n * 10), n, 10)
  x_irrelevant <- matrix(runif(n * 10), n, 10)
  z <- rnorm(n, rowSums(x_relevant), 1)
  return(list(x = cbind( x_irrelevant,x_relevant), z = z))
}

n_train <- 100
n_test <- 4

train_data <- generate_data(n_train)
x_train <- train_data$x
z_train <- train_data$z
```

### Training

Trees are recursively partitioned to minimize the CDE loss

$$ \int \int (\hat{f}(x \mid z) - f(x \mid z))^{2} dz dP(x) $$

This is efficiently calculated using an orthogonal series
representation of the conditional densities. The resolution of this
representation is controlled by `n_basis`.

```{r}
n_trees <- 5
mtry <- 4
node_size <- 20
n_basis <- 15

forest <- RFCDE(x_train, z_train, n_trees = n_trees, mtry = mtry,
                node_size = node_size, n_basis = n_basis)
```

```{r}
forest$rcpp$set_leaves_id()
```
```{r}
n_grid <- 30
x_grid <- expand.grid(x1 = seq(0, 1, length.out = n_grid),
                      x2 = seq(0, 1, length.out = n_grid))
```

```{r}
groups <- apply(x_train, 1, function(row){
  forest$rcpp$traverse_forest(row)
})
```

```{r, eval = FALSE}
groups <- apply(x_grid, 1, function(row){
  forest$rcpp$traverse_forest(row)
})
groups <-t(groups)
groups_5 <- groups[,1]


image(seq(0, 1, length.out = n_grid), xlab = "X1",
      seq(0, 1, length.out = n_grid), ylab = "X2",
      z = matrix(groups_1, n_grid, n_grid))
```